#!/usr/bin/env make

include ../Makefile.defs

CSSFLAGS=-I../

all: usage contest

contest: wgo-contest.css contest_config.py contest.cgi gallery.cgi

wgo-contest.css: wgo-contest.cpp

usage:
	@if [ ${DocumentRoot} = "" ]; then echo "USAGE: make DocumentRoot=<DocumentRoot> install"; exit 1; fi

configs: config.py contest_config.py

config.py:
	ln -s ../config.py .

contest_config.py: Makefile ../Makefile.defs
	(echo "#!/usr/bin/env ${PYTHON}"               ; \
		echo "# THIS FILE IS AUTOMATICALLY GENERATED."               ; \
		echo "# DO NOT EDIT THIS FILE. See Makefile"                 ; \
		echo ""                                                      ; \
	 echo "DocumentRoot='${DocumentRoot}'"                        ; \
	 echo "contest_dir='/contest/'"                               ; \
	 echo "contest_path='${DocumentRoot}' + contest_dir"          ; \
	 echo "icon_dir='/contest/icons/'"                            ; \
	 echo "icon_path='${DocumentRoot}' + icon_dir"                ; \
	 echo "images_dir='/contest/images/'"                         ; \
	 echo "images_path='${DocumentRoot}' + images_dir"            ; \
		echo                                                         ; \
	 echo "spool_dir='/var/spool/wgo-contest/'  # must end in trailing /" ; \
	 echo "spool_path='${DocumentRoot}' + spool_dir # must end in trailing /" ; \
		echo                                                         ; \
	 echo "tmp_directory_ttl=60"                                  ; \
	 echo "gallery_dir='/contest/gallery/'"                       ; \
	 echo "gallery_path='${DocumentRoot}'+gallery_dir"            ; \
	 echo "permission=0644"                                       ; \
	 echo "debug = 0"                                             ; \
	 echo "validator=0"                                           ; \
	 echo "datetime_format = '%Y-%m-%d'"                          ; \
	) > contest_config.py

contest.cgi: contest.py

gallery.cgi: gallery.py

dot-htaccess: dot-htaccess.sh

clean mrproper:
	/bin/rm -f *.pyc *.cgi wgo-contest.css contest_config.py *~

install: all
	install --mode=755 -d ${LIBDIR}
	install --mode=755 -d `${PYTHON} -c 'import contest_config; print contest_config.contest_path'`/include
	install --mode=755 -d `${PYTHON} -c 'import contest_config; print contest_config.contest_path'`/icons
	install --mode=755 -d `${PYTHON} -c 'import contest_config; print contest_config.contest_path'`/images
	install --mode=755 -d `${PYTHON} -c 'import contest_config; print contest_config.icon_path'`
	install --mode=755 -d `${PYTHON} -c 'import contest_config; print contest_config.spool_path'`
	install --mode=755 -d `${PYTHON} -c 'import contest_config; print contest_config.gallery_path'`

	install contest_config.py \
	        wgo_contest.py         ${LIBDIR}

	install images/gimp-splash.png \
	        images/gimp-bg.png     `${PYTHON} -c 'import contest_config; print contest_config.images_path'`

	install wgo-contest.css \
	        contest.cgi     \
	        gallery.cgi     \
	        gimp-batch      \
	        index.html             `${PYTHON} -c 'import contest_config; print contest_config.contest_path'`
