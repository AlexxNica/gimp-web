# -*- makefile -*-
#
include Makefile.defs

.PHONY: all usage clean install admin contest about develop webtools downloads

all: webtools usage wgo_config.py extended.css rdf-news.css wgo-css.cpp admin contest about develop downloads

usage:
	@if [ ${DocumentRoot} = "" ]; then echo "USAGE: make DocumentRoot=<DocumentRoot>target"; exit 1; fi

# names ending in 'path' are full pathnames
# otherwise, they are relative to DocumentRoot

extended.css: extended.cpp wgo-css.cpp

wgo_config.py: Makefile Makefile.defs
	(echo "#!/usr/bin/env ${PYTHON}"                              ; \
		echo "# THIS FILE IS AUTOMATICALLY GENERATED."               ; \
		echo "# DO NOT EDIT THIS FILE. See Makefile"                 ; \
		echo                                                         ; \
	 echo "# By convention *_path variables contain the full pathnames of directories and/or files." ;\
	 echo "# By convention *_dir variables contain the pathnames of directories relative to ${DocumentRoot}." ;\
	 echo "# user_name=''"                                 ; \
	 echo "# user_uid=''"                                  ; \
	 echo "# user_gid=''"                                  ; \
		echo                                                  ; \
	 echo "DocumentRoot_path='${DocumentRoot}'"            ; \
	 echo "admin_dir='/admin/'"                            ; \
	 echo "admin_path=DocumentRoot_path + admin_dir"       ; \
	 echo "includes_dir='/includes/'"                      ; \
	 echo "includes_path=DocumentRoot_path + includes_dir" ; \
	 echo "spool_dir='/var/'"                              ; \
	 echo "spool_path=DocumentRoot_path + spool_dir"       ; \
		echo                                                  ; \
	 echo "debug=0"                                        ; \
	 echo "validate=True"                                  ; \
	) > wgo_config.py

admin: wgo_config.py
	$(MAKE) -C admin all

contest: wgo_config.py
	$(MAKE) -C contest all

about: wgo_config.py
	$(MAKE) -C about all

develop: wgo_config.py
	$(MAKE) -C develop all

downloads: wgo_config.py
	$(MAKE) -C downloads all

webtools:
	$(MAKE) SRCDIR=${SRCDIR} -C tools all

extended.css:

rdf-news.css: rdf-news.cpp

clean mrproper:
	/bin/rm -f wgo_config.py extended.css *.pyc *~ rdf-news.css
	$(MAKE) -C contest clean
	$(MAKE) -C admin clean
	$(MAKE) -C about clean
	$(MAKE) -C develop clean
	$(MAKE) -C tools clean

install: install-common install-admin install-contest install-about install-develop install-downloads

install-common: all
	install -m 755 -d ${LIBDIR}
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' wgo.py        > ${LIBDIR}/wgo.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' wgo_develop.py        > ${LIBDIR}/wgo_develop.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' apache_ssi.py > ${LIBDIR}/apache_ssi.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' xhtml.py      > ${LIBDIR}/xhtml.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' rdf.py        > ${LIBDIR}/rdf.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' x_xml.py      > ${LIBDIR}/x_xml.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' changelog.py  > ${LIBDIR}/changelog.py
	install            wgo_config.py ${LIBDIR}
	install -m 644 extended.css  ${DocumentRoot}/style/
	install -m 644 rdf-news.css  ${DocumentRoot}/style/

install-admin: admin
	$(MAKE) -C admin install

install-contest: contest
	$(MAKE) -C contest install

install-about: about
	$(MAKE) -C about install

install-develop: develop
	$(MAKE) -C develop install

install-downloads: downloads
	$(MAKE) -C downloads install

dirs: wgo_config.py
	$(MAKE) -C admin dirs
	$(MAKE) -C contest dirs
