# -*- makefile -*-
#
include Makefile.defs

all: usage wgo_config.py extended.css rdf-news.css wgo-css.cpp admin contest about

usage:
	@if [ ${DocumentRoot} = "" ]; then echo "USAGE: make DocumentRoot=<DocumentRoot>target"; exit 1; fi

# names ending in 'path' are full pathnames
# otherwise, they are relative to DocumentRoot

extended.css: extended.cpp wgo-css.cpp

wgo_config.py: Makefile Makefile.defs
	(echo "#!/usr/bin/env ${PYTHON}"                              ; \
		echo "# THIS FILE IS AUTOMATICALLY GENERATED."               ; \
		echo "# DO NOT EDIT THIS FILE. See Makefile"                 ; \
		echo                                                         ; \
		echo "# All names ending in 'path' are full paths"           ; \
		echo "# All names ending in 'dir' are relative to DocumentRoot and must end with a '/'" ; \
	 echo "# user_name=''"                                  ; \
	 echo "# user_uid=''"                             ; \
	 echo "# user_gid=''"                             ; \
		echo                                                         ; \
	 echo "DocumentRoot_path='${DocumentRoot}'"                   ; \
	 echo "admin_dir='/admin/'"                                   ; \
	 echo "admin_path='${DocumentRoot}' + admin_dir"              ; \
	 echo "includes_dir='/includes/'"                             ; \
	 echo "includes_path='${DocumentRoot}' + includes_dir"        ; \
	 echo "spool_dir='/var/spool/' # must end in trailing /"      ; \
	 echo "spool_path='${DocumentRoot}' + spool_dir # must end in trailing /" ; \
		echo                                                         ; \
	 echo "debug=0"                                               ; \
	 echo "validate=True"                                         ; \
	) > wgo_config.py

admin: wgo_config.py
	cd admin && $(MAKE) all

contest: wgo_config.py
	cd contest && $(MAKE) all

about: wgo_config.py
	cd about && $(MAKE) all

extended.css:

rdf-news.css: rdf-news.cpp

clean mrproper:
	/bin/rm -f wgo_config.py extended.css *.pyc *~ rdf-news.css
	cd contest && $(MAKE) clean
	cd admin && $(MAKE) clean
	cd about && $(MAKE) clean

install: install-common install-admin install-contest install-about

install-common: all
	install --mode=755 -d ${LIBDIR}
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' wgo.py       > ${LIBDIR}/wgo.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' xhtml.py     > ${LIBDIR}/xhtml.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' rdf.py       > ${LIBDIR}/rdf.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' x_xml.py     > ${LIBDIR}/x_xml.py
	sed -e 's|$${PYTHON}|${PYTHON}|g' -e 's|$${LIBDIR}|${LIBDIR}|g' changelog.py > ${LIBDIR}/changelog.py
	install            wgo_config.py ${LIBDIR}
	install --mode=644 extended.css  ${DocumentRoot}/style/
	install --mode=644 rdf-news.css  ${DocumentRoot}/style/

install-admin: admin
	cd admin && $(MAKE) install

install-contest: contest
	cd contest && $(MAKE) install

install-about: about
	cd about && $(MAKE) install

dirs: wgo_config.py
	cd admin && $(MAKE) dirs
	cd contest && $(MAKE) dirs
